name: Health Check

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check Service Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Server
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://equity-agent-api.fly.dev/health)
          if [ "$response" != "200" ]; then
            echo "❌ API Server health check failed (HTTP $response)"
            exit 1
          fi
          echo "✅ API Server is healthy"
      
      - name: Check LiveKit Core
        run: |
          # Check if LiveKit Core is reachable (will get 404 on root, but that's OK)
          response=$(curl -s -o /dev/null -w "%{http_code}" https://equity-livekit-core.fly.dev/)
          if [ "$response" != "404" ] && [ "$response" != "200" ]; then
            echo "❌ LiveKit Core unreachable (HTTP $response)"
            exit 1
          fi
          echo "✅ LiveKit Core is reachable"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::One or more services are unhealthy. Check Fly.io dashboard."

