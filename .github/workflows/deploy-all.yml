name: Deploy All Services

on:
  workflow_dispatch:

jobs:
  deploy-core:
    name: Deploy LiveKit Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy LiveKit Core
        run: cd deploy/livekit-core && flyctl deploy --ha=false --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  
  deploy-sip:
    name: Deploy LiveKit SIP
    runs-on: ubuntu-latest
    needs: deploy-core
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy LiveKit SIP
        run: cd deploy/livekit-sip && flyctl deploy --ha=false --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  
  deploy-minio:
    name: Deploy MinIO
    runs-on: ubuntu-latest
    needs: deploy-core
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy MinIO
        run: cd deploy/minio && flyctl deploy --ha=false --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  
  deploy-agent:
    name: Deploy Agent Workers
    runs-on: ubuntu-latest
    needs: [deploy-core, deploy-minio]
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Prepare build context
        run: cp -r livekit-agent deploy/agent/
      - name: Deploy Agent Workers
        run: cd deploy/agent && flyctl deploy --ha=false --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    needs: [deploy-core, deploy-sip, deploy-minio]
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Prepare build context
        run: cp -r livekit-agent deploy/api/
      - name: Deploy API Server
        run: cd deploy/api && flyctl deploy --ha=false --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

